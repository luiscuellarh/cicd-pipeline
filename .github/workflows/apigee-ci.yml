
name: Apigee Configurable Proxy CI 

on: push
  
env:
  APIGEE_ORG: bap-emea-apigee-4
  APIGEE_CONFIG_ENV: config-env
  TEST_HOST: https://35-241-29-146.nip.io

jobs:
  Apigee-Deploy:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Create Dependencies (npm) Cache 
      - name: Cache node modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          # npm cache files are stored in `~/.npm` 
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-


      # Install dependencies (npm)
      - name: Install Dependencies
        run: npm install --silent --no-fund
      

      # google-github-actions: Authenticate against Google Cloud with Service Account (Secret) 
      - id: 'auth'
        uses: 'google-github-actions/auth@v0'
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'


      # google-github-actions: Install and configure gcloud (alpha for Apigee commands)
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v0'
        with:
          install_components: 'alpha'

#      - name: 'Use gcloud CLI'
#        run: 'gcloud info'

      # Deploy Configurable Proxy
      - name: 'deploy configurable proxy'
        run: |
          mv ./proxy/src/main/apigee/environments/ENVIRONMENT-NAME ./proxy/src/main/apigee/environments/$APIGEE_CONFIG_ENV
          gcloud alpha apigee archives deploy --organization=$APIGEE_ORG --environment=$APIGEE_CONFIG_ENV --source=proxy
